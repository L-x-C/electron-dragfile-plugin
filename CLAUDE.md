# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a native Node.js addon built with Rust and napi-rs that provides system-wide mouse event monitoring capabilities. The project consists of:

- **Rust native code** (`src/lib.rs`) - Core mouse event handling using the `rdev` crate
- **Node.js bindings** (`index.js`) - Auto-generated NAPI wrapper with platform-specific binary loading
- **TypeScript definitions** (`index.d.ts`) - Auto-generated type definitions
- **Build system** - Uses napi-rs for cross-platform compilation

## Common Development Commands

### Building
```bash
# Build release binaries for all platforms
npm run build

# Build debug version for current platform
npm run build:debug

# Build simple release for current platform
npm run build:simple

# Generate build artifacts for distribution
npm run artifacts
```

### Testing
```bash
# Run the test script to verify mouse monitoring functionality
node test.js

# Run using npm test (alias for node test.js)
npm test
```

### Development Workflow
```bash
# Install dependencies
npm install

# Build the native addon
npm run build

# Test the implementation
node test.js
```

## Architecture Overview

### Core Components

1. **Rust Native Layer** (`src/lib.rs`)
   - Uses `rdev` crate for cross-platform mouse event capture
   - Implements global state management with `lazy_static`
   - Provides thread-safe callback system using NAPI's ThreadsafeFunction
   - Handles platform-specific event conversion and coordinate tracking

2. **Node.js Binding Layer** (`index.js`)
   - Auto-generated by NAPI-RS
   - Handles platform-specific binary loading
   - Provides clean JavaScript API surface

3. **Build System**
   - `build.rs`: Platform-specific linking configuration (macOS frameworks)
   - `Cargo.toml`: Rust dependencies and NAPI configuration
   - Uses napi-rs for cross-platform compilation

### Key Architecture Patterns

- **Global State Management**: Uses `lazy_static` with `Arc<Mutex<>>` for thread-safe access
- **Event Loop Integration**: Separate monitoring thread with NAPI threadsafe callbacks
- **Coordinate Tracking**: Maintains last known mouse position for button events
- **Platform Abstraction**: Unified event format across Windows, macOS, and Linux

### State Management
The `MonitorState` struct maintains:
- Active monitoring status
- Registered callbacks with unique IDs
- Shutdown communication channels
- Monitor thread handles

### Event Flow
1. `rdev` captures native mouse events
2. Events are converted to unified `MouseEvent` format
3. Coordinates are tracked for button events (which don't include position data)
4. Events are dispatched to all registered JavaScript callbacks
5. Thread-safe NAPI callbacks handle JavaScript invocation

## Platform-Specific Requirements

### macOS
- Requires Accessibility permissions for global mouse monitoring
- Links against CoreFoundation, CoreGraphics, Cocoa, AppKit, Foundation frameworks
- Minimum deployment target: macOS 10.13

### Windows
- Requires Windows 10+
- No additional permissions required

### Linux
- Requires X11 display server
- Distinguishes between glibc and musl for binary compatibility

## API Surface

### Main Functions
- `startMouseMonitor()`: Begin global mouse monitoring
- `stopMouseMonitor()`: Stop monitoring and cleanup resources
- `onMouseEvent(callback)`: Register event listener, returns callback ID
- `removeMouseEventListener(id)`: Remove specific listener
- `isMonitoring()`: Check current monitoring status

### MouseEvent Structure
```typescript
interface MouseEvent {
  eventType: string;    // "mousedown", "mouseup", "mousemove", "wheel"
  x: number;          // Mouse X coordinate
  y: number;          // Mouse Y coordinate
  button: number;     // 0=none, 1=left, 2=middle, 3=right
  timestamp: number;  // Unix timestamp
  platform: string;  // "macos", "windows", "linux"
}
```

## Testing and Validation

The `test.js` file provides comprehensive testing:
- Verifies plugin loading and error handling
- Tests mouse monitoring startup
- Validates event callback registration
- Demonstrates proper cleanup on SIGINT

Run tests with `node test.js` and verify mouse events are captured when moving and clicking the mouse.